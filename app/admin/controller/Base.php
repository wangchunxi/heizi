<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/5/25
 * Time: 10:23
 */
namespace app\admin\controller;
use app\admin\model\Menu;
use Auth\Auth;
use think\Controller;
use app\common;
class  Base extends  common{
    private $userInfo;
    private $menu_id;
    private $menu_info;
    public function __construct()
    {
        parent::__construct(); // TODO: Change the autogenerated stub
        if(!session('uid')){
            $this->error('请先登录',Url('admin/share/login'));
        }
        /*判断用户是否登录*/
        try{
            /*获取当前页面的父级ID*/
            $this->menu_id = input('menu_id');
            $this->get_menu_info();
            if(session('uid')!=1 && session('uid')){
                $auth =  new Auth();
                $url = get_url();
                /*权限验证*/
                $auth_vlit = $auth->check($url,session('uid'));
                if($auth_vlit!=true){
                    $img =__ADMIN_LAYER__."/layui/images/404.jpg";
                    exit(
                         widget("admin/Webplug/webplug",
                                json_encode(
                                    array('config'=>array('tips'=>'你没有权限访问','img'=>$img)
                                        ,'plug'=>'error_web')
                                )
                         )
                    );
                }
            }
        }catch( \Exception $e){
            $this->error($e->getMessage());
        }
    }

    /**
     * 公共页面展示
     * @param $data 要展示的配置
     * @param string $view 要展示的页面文件
     * @param string $request_url 要展示的页面文件里的链接
     * @return \think\response\View 返回视图
     */
    function Set_ListPage($data,$view ='',$request_url='',$data_arr=''){
        if(empty($view)){
            $view = 'public/table_list';
        }
        $menu_id = $this->menu_id;
        //if($menu_id){
            if($view == 'public/table_list'){
                /*头部按钮查询*/
               // $Button = $Button->Set_location(1)->Set_menu_id($menu_id)->Set_Uid(session('uid'))->dispose();
                $Button = $this->get_Button_info(1);
                //dump($Button);
                if($Button){
                    $Button_arr['Button'] = $Button; $Button_arr['type'] = 'head';
                }
            }
            if($view == "public/table_list_cp"){
                /*列表的数据查询*/
               // $Button = $Button->Set_location(2)->Set_menu_id($menu_id)->Set_Uid(session('uid'))->dispose();
                $Button = $this->get_Button_info(2);
                if($Button){
                    $Button_arr['Button'] = $Button; $Button_arr['type'] = 'list';
                }
            }
            if($view == 'public/info'){
                $menu_name =  (new Menu())->set_map($map = array('id'=>$menu_id,'status'=>1))->set_fied('menu_name')->get_menu_info();
                if($menu_name){
                      $this->assign('menu_name',$menu_name);
                }
            }

        //}
        if($data_arr){
            $this->assign('data',$data_arr);
        }
        $Button_arr = isset($Button_arr) ?$Button_arr : '';
        $this->assign('Button_arr',$Button_arr);
        $this->assign('config',$data);
        $this->assign('request_url',$request_url);
        return view($view);
    }

    /**简单的状态位改变
     * @param $table 表名
     * @param $status 要改变的后的状态值
     * @param $field_name 要改变的状态位
     * @param $handle   属于哪种操作类型
     * @return array|string 返回 true| false
     * @throws \think\Exception
     */
    function Change_status(){
        $table=input('table');                  $status = input('status');
        $field_name=input('field_name');        $handle = input('handle');
        $data['id'] = input('id');
        $data_status = db($table)->where("id",$data['id'])->field($field_name)->find();
        if($data_status){
            if($data_status[$field_name] == 1){
                $status  = 0;
            }
            if($data_status[$field_name] == 0){
                $status = 1;
            }
        }
        $data[$field_name] = $status;
        $result = db($table)->update($data);
        if(!$result){
            return ajax_return(false,'操作失败');
        }
        return ajax_return(true,'操作成功',$status);
    }
    /*
     * 获取当前页面的所有访问详情详情
    */
    function get_menu_info(){
        $menu_id =$this->menu_id;
        $Button = new \Button();
        /*头部按钮查询*/
        $Button = $Button->Set_menu_id($menu_id)->Set_Uid(session('uid'))->dispose();
        return $this->menu_info = $Button;
    }
    /**
     * 页面按键输出
     */
    function  get_Button_info($Set_location='1'){
        $Button_info = $this->menu_info;
        foreach($Button_info as $k=>$v){
            /*头部按钮*/
            if($Set_location == 1){
                if($v['nav_seat'] == 1  or  $v['nav_seat'] == 3){
                    $data[] = $v;
                }
            }
            /*列表页按钮*/
            if($Set_location == 2){
                if($v['nav_seat'] == 2  or  $v['nav_seat'] == 3){
                    $data[] = $v;
                }
            }
        }
        return $data;
    }

}
